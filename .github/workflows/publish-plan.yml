name: Publish plan.json

on:
  workflow_dispatch: {}
  schedule:
    - cron: "05 13 * * *"   # 13:05 UTC daily

permissions:
  contents: write

concurrency:
  group: publish-plan
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install requests
          fi

      - name: Generate plan.json
        env:
          WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
        run: python plan_generator.py

      - name: Validate plan.json has tide/current summaries
        run: |
          python - <<'PY'
          import json
          d=json.load(open('docs/plan.json'))
          assert any(rec.get('tide_summary') for day in d['days'] for rec in day['recommendations']), "No tide_summary found"
          assert any(rec.get('current_summary') is not None for day in d['days'] for rec in day['recommendations']), "No current_summary found"
          print("OK: tide/current summaries present")
          PY

      - name: Commit and push if changed
        run: |
          git config user.name  "spinout-bot"
          git config user.email "actions@users.noreply.github.com"
          if ! git diff --quiet -- docs/plan.json; then
            git add docs/plan.json
            git commit -m "chore: publish plan.json [skip ci]"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Upload plan.json artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: plan-json
          path: docs/plan.json
